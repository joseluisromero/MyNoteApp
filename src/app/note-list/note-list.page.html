<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button menu="m1"></ion-menu-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button (click)="downloadNotes()">
        <ion-icon slot="icon-only" name="download-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Lista de Notas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Lista de Notas</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Barra de búsqueda premium -->
  <div class="search-container">
    <ion-searchbar [(ngModel)]="searchTerm" placeholder="Buscar notas..."
      (ionInput)="searchTerm = $any($event).detail.value" class="custom-searchbar" mode="ios">
    </ion-searchbar>
  </div>

  <div class="content-container">
    <ion-accordion-group [multiple]="true" [value]="openAccordions">
      <ion-accordion *ngFor="let note of getFilteredNotes(); trackBy: trackByNotes" [value]="note.noteId.toString()"
        class="premium-accordion">

        <div slot="header" class="note-header">
          <div class="title-section">
            <h3 class="note-title">{{ note.title }}</h3>
            <p class="note-date">{{ note.createdAt | date:'medium' }}</p>
          </div>

          <div class="header-actions">
            <ion-button fill="clear" color="medium" id="popover-button-{{note.noteId}}"
              (click)="$event.stopPropagation()">
              <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
            </ion-button>
            <ion-popover trigger="popover-button-{{note.noteId}}" dismissOnSelect="true">
              <ng-template>
                <ion-content class="ion-no-padding">
                  <ion-list lines="none">
                    <ion-item button [routerLink]="['/update-note', note.noteId]">
                      <ion-icon slot="start" name="create-outline" color="secondary"></ion-icon>
                      <ion-label>Editar</ion-label>
                    </ion-item>
                    <ion-item button (click)="deleteNote(note.noteId)" lines="none">
                      <ion-icon slot="start" name="trash-outline" color="danger"></ion-icon>
                      <ion-label color="danger">Eliminar</ion-label>
                    </ion-item>
                  </ion-list>
                </ion-content>
              </ng-template>
            </ion-popover>

            <ion-icon name="chevron-down-outline" class="accordion-arrow"></ion-icon>
          </div>
        </div>

        <div class="ion-padding content-slot" slot="content">
          <!-- Detalles de la nota -->
          <div class="note-details-list">
            <div *ngFor="let detail of note.details" class="detail-item-row">
              <div class="detail-main-content">
                <div class="detail-label-row">
                  <span class="detail-key">{{ detail.key }}</span>
                </div>

                <!-- Fila Inferior: Valor y Ojo (si es sensible) -->
                <div class="detail-data-row">
                  <span class="detail-value text-wrap">
                    <ng-container *ngIf="!detail.sensitive">
                      {{ detail.value }}
                    </ng-container>
                    <ng-container *ngIf="detail.sensitive">
                      {{ detail.visible ? detail.value : '••••••••' }}
                    </ng-container>
                  </span>

                  <div class="detail-actions" *ngIf="detail.sensitive">
                    <ion-button fill="clear" size="small"
                      (click)="$event.stopPropagation(); detail.visible = !detail.visible">
                      <ion-icon slot="icon-only" [name]="detail.visible ? 'eye-outline' : 'eye-off-outline'"></ion-icon>
                    </ion-button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones de Acción -->
        </div>

      </ion-accordion>
    </ion-accordion-group>
  </div>

  <!-- Botón Flotante Draggable -->
  <ion-fab slot="fixed" [style.bottom.px]="fabPosition.y || 80" [style.right.px]="fabPosition.x || 20"
    (touchstart)="onDragStart($event)" (touchmove)="onDragMove($event)" (touchend)="onDragEnd()">
    <ion-fab-button [routerLink]="['/create-note']">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>